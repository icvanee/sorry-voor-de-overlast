{% extends "base.html" %}

{% block title %}Wedstrijd Details - {{ match.home_team }} vs {{ match.away_team }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="fas fa-futbol"></i>
                {{ match.home_team }} vs {{ match.away_team }}
            </h2>
            <p class="text-muted">
                {{ match.match_date|date_nl }}
                {% if match.is_home %}
                    <span class="badge bg-primary ms-2">THUIS</span>
                {% else %}
                    <span class="badge bg-secondary ms-2">UIT</span>
                {% endif %}
                {% if match.is_played %}
                    <span class="badge bg-success ms-2">GESPEELD</span>
                {% else %}
                    <span class="badge bg-warning ms-2">GEPLAND</span>
                {% endif %}
            </p>
        </div>
        <div>
            <a href="{{ url_for('single_planning.dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Terug naar Dashboard
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Current Planning -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> Teamplanning
                        <span class="badge bg-{{ 'success' if planning|length == 4 else 'warning' if planning|length < 4 else 'danger' }}">
                            {{ planning|length }} spelers
                        </span>
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-warning" onclick="toggleMatchPin()">
                            {% if planning|selectattr('is_pinned')|list %}
                                <i class="fas fa-unlock"></i> Alles ontpinnen
                            {% else %}
                                <i class="fas fa-lock"></i> Alles pinnen
                            {% endif %}
                        </button>
                        <button type="button" class="btn btn-success" onclick="toggleMatchPlayed()">
                            {% if match.is_played %}
                                <i class="fas fa-undo"></i> Markeer als niet gespeeld
                            {% else %}
                                <i class="fas fa-check"></i> Markeer als gespeeld
                            {% endif %}
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if planning %}
                        <div class="list-group">
                            {% for player in planning %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">
                                            {{ player.player_name }}
                                            {% if player.is_pinned %}
                                                <i class="fas fa-thumbtack text-warning"></i>
                                            {% endif %}
                                            {% if player.actually_played %}
                                                <i class="fas fa-check-circle text-success"></i>
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted">{{ player.role or 'Speler' }}</small>
                                    </div>
                                    <div class="btn-group btn-group-sm" role="group">
                    <button type="button" 
                        class="btn btn-outline-warning {% if player.is_pinned %}active{% endif %} btn-player-pin"
                        data-player-id="{{ player.player_id }}"
                        data-next-pin="{{ 'false' if player.is_pinned else 'true' }}">
                                            <i class="fas fa-thumbtack"></i>
                                        </button>
                    <button type="button" 
                        class="btn btn-outline-success {% if player.actually_played %}active{% endif %} btn-actually-played"
                        data-player-id="{{ player.player_id }}"
                        data-next-played="{{ 'false' if player.actually_played else 'true' }}">
                                            <i class="fas fa-check"></i>
                                        </button>
                    <button type="button" 
                        class="btn btn-outline-danger btn-remove-player"
                        data-player-id="{{ player.player_id }}">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Geen spelers toegewezen</h5>
                            <p class="text-muted">Voeg spelers toe uit de beschikbare lijst om het team te vormen.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Available Players -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user-plus"></i> Beschikbare spelers
                        <span class="badge bg-info">{{ available_players|length }}</span>
                    </h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if available_players %}
                        <div class="list-group list-group-flush">
                            {% for player in available_players %}
                                <div class="list-group-item border-0 px-0 d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">{{ player.name }}</h6>
                                        <small class="text-muted">{{ player.role or 'Speler' }}</small>
                                    </div>
                    <button type="button" 
                        class="btn btn-sm btn-outline-primary btn-add-player"
                        data-player-id="{{ player.id }}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-users-cog fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">Alle actieve spelers zijn toegewezen</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Match Information -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-info-circle"></i> Wedstrijdinformatie</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                <dt class="col-sm-4">Datum:</dt>
                <dd class="col-sm-8">{{ match.match_date|date_nl if match.match_date else 'Niet ingesteld' }}</dd>
                                
                <dt class="col-sm-4">Tijd:</dt>
                <dd class="col-sm-8">{{ match.match_time.strftime('%H:%M') if match.match_time else 'Niet ingesteld' }}</dd>
                                
                <dt class="col-sm-4">Locatie:</dt>
                <dd class="col-sm-8">{{ match.location or 'Niet ingesteld' }}</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="row">
                <dt class="col-sm-4">Type:</dt>
                                <dd class="col-sm-8">
                                    {% if match.is_cup_match %}
                    <span class="badge bg-warning">Bekerwedstrijd</span>
                                    {% else %}
                    <span class="badge bg-primary">Competitiewedstrijd</span>
                                    {% endif %}
                                </dd>
                                
                <dt class="col-sm-4">Uitslag:</dt>
                <dd class="col-sm-8">{{ match.result or 'Niet geregistreerd' }}</dd>
                                
                <dt class="col-sm-4">Notities:</dt>
                <dd class="col-sm-8">{{ match.notes or 'Geen' }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="match-data">
{
    "matchId": {{ match.id | tojson }},
    "initialPlayerIds": {{ planning | map(attribute='player_id') | list | tojson }},
    "hasPinnedPlayers": {{ ((planning|selectattr('is_pinned')|list)|length > 0) | tojson }},
    "isPlayed": {{ match.is_played | tojson }}
}
</script>

<script>
// Inline data parsed from JSON block
const __dataEl = document.getElementById('match-data');
const { matchId, initialPlayerIds, hasPinnedPlayers, isPlayed } = JSON.parse(__dataEl.textContent);

// Wire up dynamic buttons
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.btn-add-player').forEach(btn => {
        btn.addEventListener('click', () => {
            const pid = parseInt(btn.getAttribute('data-player-id'), 10);
            addPlayer(pid);
        });
    });
    document.querySelectorAll('.btn-remove-player').forEach(btn => {
        btn.addEventListener('click', () => {
            const pid = parseInt(btn.getAttribute('data-player-id'), 10);
            removePlayer(pid);
        });
    });
    document.querySelectorAll('.btn-player-pin').forEach(btn => {
        btn.addEventListener('click', () => {
            const pid = parseInt(btn.getAttribute('data-player-id'), 10);
            const nextPin = btn.getAttribute('data-next-pin') === 'true';
            togglePlayerPin(pid, nextPin);
        });
    });
    document.querySelectorAll('.btn-actually-played').forEach(btn => {
        btn.addEventListener('click', () => {
            const pid = parseInt(btn.getAttribute('data-player-id'), 10);
            const nextPlayed = btn.getAttribute('data-next-played') === 'true';
            toggleActuallyPlayed(pid, nextPlayed);
        });
    });
});

function addPlayer(playerId) {
    const currentPlayerIds = [...initialPlayerIds];
    if (!currentPlayerIds.includes(playerId)) currentPlayerIds.push(playerId);
    updateMatchPlayers(currentPlayerIds);
}

function removePlayer(playerId) {
    const currentPlayerIds = [...initialPlayerIds];
    const updated = currentPlayerIds.filter(id => id !== playerId);
    updateMatchPlayers(updated);
}

function updateMatchPlayers(playerIds) {
    fetch('/planning/api/match/' + matchId + '/players', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ match_id: matchId, player_ids: playerIds, preserve_pinned: true })
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) { showToast('Spelers bijgewerkt', 'success'); location.reload(); }
        else { showToast('Fout: ' + (d.message || d.error), 'danger'); }
    })
    .catch(e => showToast('Fout: ' + e.message, 'danger'));
}

function togglePlayerPin(playerId, pin) {
    fetch('/planning/api/player/' + playerId + '/pin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ player_id: playerId, match_id: matchId, pinned: !!pin })
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) { showToast(pin ? 'Gepind' : 'Ontpind', 'success'); location.reload(); }
        else { showToast('Fout: ' + (d.message || d.error), 'danger'); }
    })
    .catch(e => showToast('Fout: ' + e.message, 'danger'));
}

function toggleActuallyPlayed(playerId, played) {
    fetch('/planning/api/player/' + playerId + '/actually_played', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ player_id: playerId, match_id: matchId, actually_played: !!played })
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) { showToast(played ? 'Gemarkeerd als gespeeld' : 'Gemarkeerd als niet gespeeld', 'success'); location.reload(); }
        else { showToast('Fout: ' + (d.message || d.error), 'danger'); }
    })
    .catch(e => showToast('Fout: ' + e.message, 'danger'));
}

function toggleMatchPin() {
    const message = hasPinnedPlayers
        ? `Weet je zeker dat je ALLE pins wilt verwijderen voor wedstrijd #${matchId}?`
        : `Weet je zeker dat je alle spelers wilt PINNEN voor wedstrijd #${matchId}?`;
    confirmDialog(message).then(ok => {
        if (!ok) return;
        fetch('/planning/api/match/' + matchId + '/pin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ match_id: matchId, pinned: !hasPinnedPlayers })
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) { showToast('Actie uitgevoerd', 'success'); location.reload(); }
            else { showToast('Fout: ' + (d.message || d.error), 'danger'); }
        })
        .catch(e => showToast('Fout: ' + e.message, 'danger'));
    });
}

function toggleMatchPlayed() {
    const message = !isPlayed
        ? `Weet je zeker dat je wedstrijd #${matchId} wilt MARKEREN als gespeeld?`
        : `Weet je zeker dat je wedstrijd #${matchId} als NIET gespeeld wilt markeren?`;
    confirmDialog(message).then(ok => {
        if (!ok) return;
        fetch('/planning/api/match/' + matchId + '/played', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ match_id: matchId, played: !isPlayed })
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) { showToast('Actie uitgevoerd', 'success'); location.reload(); }
            else { showToast('Fout: ' + (d.message || d.error), 'danger'); }
        })
        .catch(e => showToast('Fout: ' + e.message, 'danger'));
    });
}
</script>
{% endblock %}
