{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-table"></i> Planning Matrix
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('single_planning.dashboard') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Terug naar Dashboard
            </a>
            <button class="btn btn-sm btn-success" onclick="regeneratePlanning()">
                <i class="fas fa-sync"></i> Regenereer Planning
            </button>
        </div>
        <div class="btn-group me-2">
            <button class="btn btn-sm btn-success" onclick="exportToPDF()">
                <i class="fas fa-file-pdf"></i> PDF Export
            </button>
            <button class="btn btn-sm btn-info" onclick="exportToCSV()">
                <i class="fas fa-file-excel"></i> CSV Export
            </button>
            <button class="btn btn-sm btn-secondary" onclick="window.print()">
                <i class="fas fa-print"></i> Afdrukken
            </button>
        </div>
    </div>
</div>

<!-- Matrix Controls -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showHomeAway" checked>
                    <label class="form-check-label" for="showHomeAway">
                        Toon Thuis/Uit kleurcodering
                    </label>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="compactView">
                    <label class="form-check-label" for="compactView">
                        Compacte weergave
                    </label>
                </div>
            </div>
            <div class="col-md-4">
                <div class="row g-2">
                    <div class="col-6">
                        <label for="planMode" class="form-label mb-1">Plan modus</label>
                        <select id="planMode" class="form-select form-select-sm">
                            <option value="all" selected>Alle wedstrijden</option>
                            <option value="until_date">Tot en met datum</option>
                            <option value="rest">Vanaf datum (rest)</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label for="cutoffDate" class="form-label mb-1">Grensdatum</label>
                        <input id="cutoffDate" type="date" class="form-control form-control-sm" placeholder="YYYY-MM-DD">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Matrix Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-table"></i> Planning Matrix
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm matrix-table" id="planningMatrix">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th class="sticky-column match-column">Wedstrijd</th>
                        {% for player in matrix_data.players %}
                        <th class="text-center player-column" data-player-id="{{ player.id }}">
                            <div class="player-name">
                                {{ player.name }}
                            </div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for match in matrix_data.matches %}
                    {% set match_players = [] %}
                    {% for player in matrix_data.players %}
                        {% if player.id in matrix_data.assignments and match.id in matrix_data.assignments[player.id] %}
                            {% set _ = match_players.append(player.id) %}
                        {% endif %}
                    {% endfor %}
                    {% set match_player_count = match_players|length %}
                    <tr class="match-row 
                        {% if match_player_count > 4 %}table-warning{% elif match_player_count < 4 %}table-danger{% endif %}" 
                        data-match-id="{{ match.id }}" data-player-count="{{ match_player_count }}">
                        <td class="sticky-column match-info clickable" data-href="{{ url_for('single_planning.match_detail', match_id=match.id) }}" title="Open wedstrijdplanning">
                            <div class="match-details">
                                <strong>
                                    {{ "%02d"|format(loop.index) }}. {{ match.match_date.strftime('%d/%m') if match.match_date else 'N.t.b.' }}
                                    {% if match_player_count > 4 %}
                                        <span class="badge bg-warning text-dark ms-1" title="Meer dan 4 spelers - handmatig toegestaan maar let op!">
                                            <i class="fas fa-exclamation-triangle"></i> {{ match_player_count }}
                                        </span>
                                    {% elif match_player_count < 4 %}
                                        <span class="badge bg-danger ms-1" title="Minder dan 4 spelers - regel overtreding!">
                                            <i class="fas fa-times-circle"></i> {{ match_player_count }}
                                        </span>
                                    {% endif %}
                                </strong>
                                <br>
                                <small class="match-teams">
                                    {{ match.home_team }} vs {{ match.away_team }}
                                </small>
                                <br>
                                <span class="match-type-badge">
                                    <span class="badge bg-primary">
                                        <i class="fas fa-users"></i> Competitie
                                    </span>
                                    {% if match.is_home %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-home"></i> Thuis
                                        </span>
                                    {% else %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-plane"></i> Uit
                                        </span>
                                    {% endif %}
                                    {% if match.round_name %}
                                        <br><small class="text-muted">{{ match.round_name }}</small>
                                    {% endif %}
                                </span>
                            </div>
                        </td>
                        {% for player in matrix_data.players %}
                        {% set is_assigned = player.id in matrix_data.assignments and match.id in matrix_data.assignments[player.id] %}
                        {% set is_pinned = player.id in matrix_data.pinned_assignments and match.id in matrix_data.pinned_assignments[player.id] %}
                        {% set actually_played = player.id in matrix_data.actually_played and match.id in matrix_data.actually_played[player.id] %}
                        {% set availability = matrix_data.availability.get(player.id, {}).get(match.id, {}) %}
                        {% set is_available = availability.get('is_available', True) %}
                        <td class="text-center player-cell 
                            {% if not is_available %}player-unavailable
                            {% elif is_assigned %}player-assigned
                                {% if is_pinned %} player-pinned{% endif %}
                                {% if actually_played %} player-played{% endif %}
                            {% else %}player-not-assigned{% endif %}
                            {% if match.is_home %}home-match{% else %}away-match{% endif %}
                            {% if is_available %}editable-cell{% endif %}"
                            data-player-id="{{ player.id }}" 
                            data-match-id="{{ match.id }}"
                            {% if is_available %}onclick="toggleCell(this, {{ player.id }}, {{ match.id }})"{% endif %}
                            title="{% if not is_available %}Niet beschikbaar{% if availability.get('notes') %} - {{ availability.get('notes') }}{% endif %}
                            {% else %}{{ match.home_team }} vs {{ match.away_team }}
                            {% if is_assigned %} (Toegewezen){% endif %}
                            {% if is_pinned %} - VASTGEPIND{% endif %}
                            {% if actually_played %} - GESPEELD{% endif %}{% endif %}">
                            {% if not is_available %}
                                <i class="fas fa-times text-danger fs-5"></i>
                            {% elif is_assigned %}
                                {% if actually_played %}
                                    <i class="fas fa-star text-warning fs-5" title="Daadwerkelijk gespeeld"></i>
                                {% elif is_pinned %}
                                    <i class="fas fa-thumbtack text-primary fs-5" title="Vastgepind"></i>
                                {% else %}
                                    <i class="fas fa-check text-success fs-5"></i>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-secondary sticky-bottom">
                    <tr>
                        <td class="sticky-column"><strong>TOTAAL WEDSTRIJDEN</strong></td>
                        {% for player in matrix_data.players %}
                        <td class="text-center">
                            <strong id="total-{{ player.id }}">{{ matrix_data.stats[player.id].total_matches }}</strong>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td class="sticky-column"><strong>PERCENTAGE</strong></td>
                        {% for player in matrix_data.players %}
                        <td class="text-center">
                            <strong id="percentage-{{ player.id }}">{{ "%.0f"|format(matrix_data.stats[player.id].percentage) }}%</strong>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td class="sticky-column"><strong>VASTGEPIND</strong></td>
                        {% for player in matrix_data.players %}
                        <td class="text-center">
                            <strong id="pinned-{{ player.id }}">{{ matrix_data.stats[player.id].total_pinned }}</strong>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td class="sticky-column"><strong>GESPEELD</strong></td>
                        {% for player in matrix_data.players %}
                        <td class="text-center">
                            <strong id="played-{{ player.id }}">{{ matrix_data.stats[player.id].total_played }}</strong>
                        </td>
                        {% endfor %}
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Legend -->
<div class="card mt-4">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="fas fa-info-circle"></i> Legenda
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <i class="fas fa-check text-success me-2"></i>
                <span>Toegewezen (kan bij regeneratie wijzigen)</span>
            </div>
            <div class="col-md-3">
                <i class="fas fa-thumbtack text-primary me-2"></i>
                <span>Vastgepind (blijft bij regeneratie)</span>
            </div>
            <div class="col-md-3">
                <i class="fas fa-star text-warning me-2"></i>
                <span>Daadwerkelijk gespeeld</span>
            </div>
            <div class="col-md-3">
                <i class="fas fa-times text-danger me-2"></i>
                <span>Niet beschikbaar</span>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-3">
                <span class="text-muted me-2">-</span>
                <span>Niet toegewezen</span>
            </div>
            <div class="col-md-9">
                <div class="alert alert-info mb-0 py-2">
                    <small>
                        <i class="fas fa-mouse-pointer"></i> 
                        <strong>Cyclus:</strong> Klik op een cel om te wisselen: 
                        <span class="text-muted">Niet</span> → 
                        <span class="text-success">Toegewezen</span> → 
                        <span class="text-primary">Vastgepind</span> → 
                        <span class="text-muted">Niet</span>
                    </small>
                </div>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-3">
                <span class="badge bg-success me-2">
                    <i class="fas fa-home"></i> Thuis
                </span>
                <span>Thuiswedstrijd</span>
            </div>
            <div class="col-md-3">
                <span class="badge bg-info me-2">
                    <i class="fas fa-plane"></i> Uit
                </span>
                <span>Uitwedstrijd</span>
            </div>
            <div class="col-md-3">
                <span class="badge bg-warning text-dark me-2">
                    <i class="fas fa-exclamation-triangle"></i>
                </span>
                <span>Meer dan 4 spelers (handmatig toegestaan)</span>
            </div>
            <div class="col-md-3">
                <span class="badge bg-danger me-2">
                    <i class="fas fa-times-circle"></i>
                </span>
                <span>Minder dan 4 spelers (regel overtreding)</span>
            </div>
        </div>
    </div>
</div>

<style>
/* Matrix Table Styling */
.matrix-table {
    font-size: 0.85rem;
    margin-bottom: 0;
}

.sticky-column {
    position: sticky;
    left: 0;
    background-color: white;
    z-index: 10;
    border-right: 2px solid #dee2e6;
    min-width: 200px;
}

.table-dark .sticky-column {
    background-color: #212529;
}

.table-secondary .sticky-column {
    background-color: #e2e3e5;
}

/* Sticky header and footer */
.sticky-top {
    position: sticky;
    top: 0;
    z-index: 20;
}

.sticky-bottom {
    position: sticky;
    bottom: 0;
    z-index: 20;
}

/* Table container with max height for scrolling */
.table-responsive {
    max-height: 70vh;
    overflow-y: auto;
}

/* Over-assigned match highlighting */
.table-danger {
    background-color: rgba(220, 53, 69, 0.1) !important;
}

.table-danger .sticky-column {
    background-color: rgba(220, 53, 69, 0.15) !important;
}

/* Under-assigned match highlighting (less than 4 players) */
.table-warning {
    background-color: rgba(255, 193, 7, 0.1) !important;
}

.table-warning .sticky-column {
    background-color: rgba(255, 193, 7, 0.15) !important;
}

.match-column {
    width: 200px;
    max-width: 200px;
}

.player-column {
    width: 80px;
    min-width: 80px;
}

.player-name {
    font-size: 0.75rem;
    line-height: 1.1;
}

.match-info {
    padding: 8px 12px;
}

.match-info.clickable {
    cursor: pointer;
}

.match-details {
    line-height: 1.3;
}

.match-teams {
    color: #6c757d;
    font-size: 0.7rem;
}

.match-type-badge {
    display: block;
    margin-top: 4px;
}

.match-type-badge .badge {
    font-size: 0.6rem;
    margin-right: 2px;
}

.player-cell {
    padding: 12px 8px;
    vertical-align: middle;
}

.player-assigned {
    background-color: #d1f2eb;
}

.player-pinned {
    background-color: #b3d9ff !important;
    border: 2px solid #007bff;
}

.player-played {
    background-color: #fff3cd !important;
    border: 2px solid #ffc107;
}

.player-not-assigned {
    background-color: #f8f9fa;
}

.player-unavailable {
    background-color: #f8d7da;
    cursor: not-allowed;
}

.home-match.player-assigned {
    background-color: #d4edda;
}

.away-match.player-assigned {
    background-color: #cce7ff;
}

/* Editable cells */
.editable-cell {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.editable-cell:hover {
    background-color: #fff3cd !important;
    border: 1px solid #ffeaa7;
}

.player-assigned.editable-cell:hover {
    background-color: #d1f2eb !important;
}

.loading-cell {
    opacity: 0.6;
}

/* Compact view */
.compact .matrix-table {
    font-size: 0.7rem;
}

.compact .player-cell {
    padding: 6px 4px;
}

.compact .match-info {
    padding: 6px 8px;
}

/* Print styles */
@media print {
    .btn-toolbar,
    .card:not(:has(.matrix-table)),
    .card-header:not(:has(.matrix-table)) {
        display: none !important;
    }
    
    .matrix-table {
        font-size: 0.6rem;
    }
    
    .player-assigned {
        background-color: #000 !important;
        color: white !important;
    }
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .match-column {
        width: 150px;
        min-width: 150px;
    }
    
    .player-column {
        width: 60px;
        min-width: 60px;
    }
    
    .player-name {
        font-size: 0.65rem;
    }
    
    .match-type-badge .badge {
        font-size: 0.5rem;
    }
}
</style>

<script>
// Toggle compact view
document.addEventListener('DOMContentLoaded', function() {
    const compactView = document.getElementById('compactView');
    const showHomeAway = document.getElementById('showHomeAway');
    
    if (compactView) {
        compactView.addEventListener('change', function() {
            document.body.classList.toggle('compact', this.checked);
        });

        // Apply initial compact state on load
        if (compactView.checked) {
            document.body.classList.add('compact');
        }
    }

    if (showHomeAway) {
        showHomeAway.addEventListener('change', function() {
            const cells = document.querySelectorAll('.player-cell');
            cells.forEach(cell => {
                if (this.checked) {
                    cell.classList.remove('no-color-coding');
                } else {
                    cell.classList.add('no-color-coding');
                }
            });
        });

        // Ensure initial state reflects the checkbox on load (default checked)
        if (!showHomeAway.checked) {
            document.querySelectorAll('.player-cell').forEach(cell => cell.classList.add('no-color-coding'));
        }
    }

    // Initialize row highlighting on first load so rows start red/oranje when needed
    try {
        document.querySelectorAll('tr.match-row').forEach(row => {
            const matchId = row.getAttribute('data-match-id');
            if (matchId) {
                updateMatchRowHighlighting(matchId);
            }
        });
    } catch (e) {
        console.warn('Row highlight init failed:', e);
    }

    // Make match info cells clickable to open planning detail
    document.querySelectorAll('td.match-info.clickable').forEach(cell => {
        const href = cell.getAttribute('data-href');
        if (href) {
            cell.addEventListener('click', () => {
                window.location.href = href;
            });
        }
    });
});

// Cell editing functionality for Single Planning System with 3-state cycle
function toggleCell(cell, playerId, matchId) {
    if (cell.classList.contains('loading-cell')) return;
    
    cell.classList.add('loading-cell');
    
    fetch(`{{ url_for('single_planning.edit_matrix_cell') }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            player_id: playerId,
            match_id: matchId,
            action: 'cycle'  // Always cycle through states
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const icon = cell.querySelector('i') || cell.querySelector('span');
            
            // Update cell based on state
            cell.classList.remove('player-assigned', 'player-not-assigned', 'player-pinned', 'player-played');
            
            if (data.assigned) {
                cell.classList.add('player-assigned');
                
                if (data.is_pinned) {
                    // State: Pinned (vastgepind)
                    cell.classList.add('player-pinned');
                    icon.outerHTML = '<i class="fas fa-thumbtack text-primary fs-5" title="Vastgepind - blijft bij regeneratie"></i>';
                    showToast(`Speler vastgepind! Blijft bij regeneratie.`, 'info');
                } else {
                    // State: Assigned (toegewezen)
                    icon.outerHTML = '<i class="fas fa-check text-success fs-5" title="Toegewezen - kan bij regeneratie wijzigen"></i>';
                    showToast(`Speler toegewezen!`, 'success');
                }
            } else {
                // State: Not assigned (niet toegewezen)
                cell.classList.add('player-not-assigned');
                icon.outerHTML = '<span class="text-muted">-</span>';
                showToast(`Speler verwijderd uit planning.`, 'info');
            }
            
            // Update player statistics
            updatePlayerStats(playerId, data.stats);
            
            // Update match row highlighting
            updateMatchRowHighlighting(matchId);
            
            // Check player count and show appropriate message
            if (data.match_player_count > 4) {
                showToast(`⚠️ Meer dan 4 spelers: ${data.match_player_count} spelers toegewezen (handmatig toegestaan)`, 'warning');
            } else if (data.match_player_count < 4) {
                showToast(`❌ Te weinig spelers: ${data.match_player_count} spelers toegewezen (regel is min 4)`, 'error');
            }
        } else {
            showToast(data.error || 'Fout bij bijwerken planning', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast(`Netwerkfout: ${error.message}`, 'error');
    })
    .finally(() => {
        cell.classList.remove('loading-cell');
    });
}

function updatePlayerStats(playerId, stats) {
    // Update totals
    const totalCell = document.getElementById(`total-${playerId}`);
    if (totalCell && stats) {
        totalCell.textContent = stats.total_matches || 0;
    }
    
    const percentageCell = document.getElementById(`percentage-${playerId}`);
    if (percentageCell && stats) {
        percentageCell.textContent = `${Math.round(stats.percentage || 0)}%`;
    }
    
    const pinnedCell = document.getElementById(`pinned-${playerId}`);
    if (pinnedCell && stats) {
        pinnedCell.textContent = stats.total_pinned || 0;
    }
    
    const playedCell = document.getElementById(`played-${playerId}`);
    if (playedCell && stats) {
        playedCell.textContent = stats.total_played || 0;
    }
}

function updateMatchRowHighlighting(matchId) {
    const matchRow = document.querySelector(`tr[data-match-id="${matchId}"]`);
    if (!matchRow) return;
    
    const assignedCells = matchRow.querySelectorAll('.player-assigned');
    const playerCount = assignedCells.length;
    
    // Update row highlighting based on player count
    matchRow.classList.remove('table-danger', 'table-warning');
    
    if (playerCount > 4) {
        matchRow.classList.add('table-warning'); // Orange for >4 players
    } else if (playerCount < 4) {
        matchRow.classList.add('table-danger'); // Red for <4 players
    }
    // No class for exactly 4 players (normal/green)
    
    // Update match info badge
    const matchInfo = matchRow.querySelector('.match-details strong');
    if (matchInfo) {
        // Remove existing badges
        const existingBadges = matchInfo.querySelectorAll('.badge');
        existingBadges.forEach(badge => badge.remove());
        
        if (playerCount > 4) {
            const badge = document.createElement('span');
            badge.className = 'badge bg-warning text-dark ms-1';
            badge.title = 'Meer dan 4 spelers - handmatig toegestaan maar let op!';
            badge.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${playerCount}`;
            matchInfo.appendChild(badge);
        } else if (playerCount < 4) {
            const badge = document.createElement('span');
            badge.className = 'badge bg-danger ms-1';
            badge.title = 'Minder dan 4 spelers - regel overtreding!';
            badge.innerHTML = `<i class="fas fa-times-circle"></i> ${playerCount}`;
            matchInfo.appendChild(badge);
        }
    }
    
    matchRow.setAttribute('data-player-count', playerCount);
}

// Regeneration functionality - simplified version
function regeneratePlanning() {
    console.log('🔄 Regenerate button clicked');
    
    const planModeEl = document.getElementById('planMode');
    const cutoffDateEl = document.getElementById('cutoffDate');
    const planMode = planModeEl ? planModeEl.value : 'all';
    const cutoffDate = cutoffDateEl ? cutoffDateEl.value : '';

    if (planMode !== 'all' && !cutoffDate) {
        showToast('Kies een grensdatum bij deze planmodus.', 'warning');
        return;
    }

    const modeText = planMode === 'all' ? 'alle wedstrijden' : planMode === 'until_date' ? `wedstrijden tot en met ${cutoffDate || '...datum...'}` : `wedstrijden vanaf ${cutoffDate || '...datum...'}`;

    if (!confirm(`🔄 Planning regenereren voor ${modeText}?\n\n✅ Vastgepinde spelers blijven op hun plek\n🔄 Toegewezen spelers worden opnieuw verdeeld\n\nDoorgaan?`)) {
        console.log('❌ User cancelled regeneration');
        return;
    }
    
    console.log('✅ User confirmed, starting regeneration...');
    
    // Show loading state
    const btn = document.querySelector('button[onclick="regeneratePlanning()"]');
    if (btn) {
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Regenereren...';
        btn.disabled = true;
        
        console.log('🔄 Button state changed to loading');
        
        // Use XMLHttpRequest instead of fetch for better compatibility
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/planning/api/regenerate', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
        
        xhr.onreadystatechange = function() {
            console.log('🔗 XHR state:', xhr.readyState, 'Status:', xhr.status);
            
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    console.log('✅ Success response:', xhr.responseText);
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            showToast('🎯 Planning geregenereerd! Gepinde spelers behouden.', 'success');
                            // Refresh the page to show updated planning
                            setTimeout(() => {
                                console.log('🔄 Refreshing page...');
                                window.location.reload();
                            }, 1500);
                        } else {
                            showToast(data.error || 'Fout bij regenereren planning', 'error');
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }
                    } catch (e) {
                        console.error('❌ JSON parse error:', e);
                        showToast('Onverwacht serverantwoord', 'error');
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } else {
                    // Try to read JSON error with message from server (e.g. 401/403)
                    let msg = `Serverfout: ${xhr.status} ${xhr.statusText}`;
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data && (data.error || data.message)) {
                            msg = data.error || data.message;
                        }
                    } catch (_) {}
                    console.error('❌ HTTP Error:', xhr.status, xhr.statusText);
                    showToast(msg, 'error');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        };
        
        console.log('📤 Sending regenerate request...');
        const payload = {
            plan_mode: planMode,
            cutoff_date: cutoffDate || null
        };
        xhr.send(JSON.stringify(payload));
    } else {
        console.error('❌ Button not found');
        alert('Knop niet gevonden');
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'success'} toast-message`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 250px;
        opacity: 0;
        transition: opacity 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 0.375rem;
    `;
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : type === 'info' ? 'info-circle' : 'check-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    setTimeout(() => toast.style.opacity = '1', 10);
    setTimeout(() => {
        if (document.body.contains(toast)) {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }
    }, type === 'warning' ? 6000 : 4000);
}

// Export functions (placeholder)
function exportToPDF() {
    showToast('PDF Export functionaliteit volgt in een latere versie', 'info');
}

function exportToCSV() {
    showToast('CSV Export functionaliteit volgt in een latere versie', 'info');
}

// Add no-color-coding style
const style = document.createElement('style');
style.textContent = `
    .no-color-coding.player-assigned {
        background-color: #d1f2eb !important;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
